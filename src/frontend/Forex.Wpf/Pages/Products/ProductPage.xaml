<Page
    x:Class="Forex.Wpf.Pages.Products.ProductPage"
    xmlns="http://schemas.microsoft.com/winfx/2006/xaml/presentation"
    xmlns:x="http://schemas.microsoft.com/winfx/2006/xaml"
    xmlns:d="http://schemas.microsoft.com/expression/blend/2008"
    xmlns:mc="http://schemas.openxmlformats.org/markup-compatibility/2006"
    xmlns:md="http://materialdesigninxaml.net/winfx/xaml/themes"
    x:Name="RootPage"
    Title="ProductPage"
    d:DesignHeight="650"
    d:DesignWidth="1100"
    Loaded="Page_Loaded"
    mc:Ignorable="d">

    <Page.Resources>
        <Style x:Key="DataGridStyle" TargetType="DataGrid">
            <Setter Property="Background" Value="White" />
            <Setter Property="BorderThickness" Value="0" />
            <Setter Property="GridLinesVisibility" Value="Horizontal" />
            <Setter Property="HorizontalGridLinesBrush" Value="#E0E0E0" />
            <Setter Property="RowBackground" Value="White" />
            <Setter Property="AlternatingRowBackground" Value="#F9F9F9" />
            <Setter Property="CanUserAddRows" Value="True" />
            <Setter Property="CanUserDeleteRows" Value="False" />
            <Setter Property="AutoGenerateColumns" Value="False" />
            <Setter Property="SelectionMode" Value="Single" />
            <Setter Property="SelectionUnit" Value="FullRow" />
            <Setter Property="EnableRowVirtualization" Value="True" />
            <Setter Property="EnableColumnVirtualization" Value="True" />
            <Setter Property="RowHeight" Value="45" />
            <Setter Property="RowHeaderWidth" Value="0" />
            <Setter Property="HeadersVisibility" Value="Column" />
        </Style>

        <Style x:Key="ColumnHeaderStyle" TargetType="DataGridColumnHeader">
            <Setter Property="Background" Value="#F5F5F5" />
            <Setter Property="Foreground" Value="#424242" />
            <Setter Property="FontWeight" Value="SemiBold" />
            <Setter Property="FontSize" Value="13" />
            <Setter Property="Padding" Value="12,10" />
            <Setter Property="HorizontalContentAlignment" Value="Center" />
            <Setter Property="VerticalContentAlignment" Value="Center" />
            <Setter Property="BorderThickness" Value="0,0,0,1" />
            <Setter Property="BorderBrush" Value="#E0E0E0" />
        </Style>

        <Style x:Key="CellStyle" TargetType="DataGridCell">
            <Setter Property="BorderThickness" Value="0" />
            <Setter Property="Padding" Value="8,0" />
            <Setter Property="VerticalContentAlignment" Value="Center" />
            <Setter Property="FocusVisualStyle" Value="{x:Null}" />
            <Style.Triggers>
                <Trigger Property="IsSelected" Value="True">
                    <Setter Property="Background" Value="#E3F2FD" />
                    <Setter Property="Foreground" Value="#1976D2" />
                </Trigger>
            </Style.Triggers>
        </Style>

        <Style x:Key="ComboBoxStyle" TargetType="ComboBox">
            <Setter Property="Background" Value="Transparent" />
            <Setter Property="BorderThickness" Value="0" />
            <Setter Property="Padding" Value="8,0" />
            <Setter Property="VerticalAlignment" Value="Center" />
            <Setter Property="IsTextSearchEnabled" Value="True" />
        </Style>

        <Style x:Key="TextStyle" TargetType="TextBlock">
            <Setter Property="VerticalAlignment" Value="Center" />
            <Setter Property="Foreground" Value="Black" />
            <Setter Property="Padding" Value="8,0" />
            <Setter Property="TextAlignment" Value="Right" />
        </Style>

        <Style x:Key="ProductNameComboBoxStyle" TargetType="ComboBox">
            <Setter Property="ItemsSource" Value="{Binding DataContext.AvailableProducts, RelativeSource={RelativeSource AncestorType=Page}}" />
            <Setter Property="DisplayMemberPath" Value="Name" />
            <Setter Property="HorizontalContentAlignment" Value="Center" />
            <Setter Property="VerticalContentAlignment" Value="Center" />
            <Setter Property="FontSize" Value="15" />
            <Setter Property="BorderThickness" Value="0" />
            <Setter Property="Background" Value="Transparent" />
            <Setter Property="Foreground" Value="Black" />
        </Style>

        <Style x:Key="ProductCodeComboBoxStyle" TargetType="ComboBox">
            <Setter Property="ItemsSource" Value="{Binding DataContext.AvailableProducts, RelativeSource={RelativeSource AncestorType=Page}}" />
            <Setter Property="DisplayMemberPath" Value="Code" />
            <Setter Property="HorizontalContentAlignment" Value="Center" />
            <Setter Property="VerticalContentAlignment" Value="Center" />
            <Setter Property="FontSize" Value="15" />
            <Setter Property="BorderThickness" Value="0" />
            <Setter Property="Background" Value="Transparent" />
            <Setter Property="Foreground" Value="Black" />
        </Style>
    </Page.Resources>

    <Grid Margin="15">
        <Grid.RowDefinitions>
            <RowDefinition Height="Auto" />
            <RowDefinition Height="*" />
            <RowDefinition Height="Auto" />
        </Grid.RowDefinitions>

        <!--  Header  -->
        <DockPanel LastChildFill="False">
            <Label
                Content="Mahsulotlar kirim oynasi"
                FontSize="18"
                FontWeight="Bold"
                Foreground="{StaticResource SecondaryTextColor}" />

            <Button
                x:Name="btnBack"
                Margin="0,0,0,5"
                Padding="8,0"
                md:ButtonAssist.CornerRadius="4"
                md:ElevationAssist.Elevation="Dp24"
                Background="{DynamicResource BackButtonBackground}"
                BorderBrush="{StaticResource BackButtonBorder}"
                Click="BtnBack_Click"
                Content="🔙 Orqaga"
                DockPanel.Dock="Right"
                Foreground="{StaticResource BackButtonForeground}" />
        </DockPanel>

        <!--  Main Content  -->
        <Grid Grid.Row="1" Margin="0,10">
            <Grid.ColumnDefinitions>
                <ColumnDefinition Width="2.5*" />
                <ColumnDefinition Width="10" />
                <ColumnDefinition Width="*" />
            </Grid.ColumnDefinitions>

            <!--  Left Panel - Products DataGrid  -->
            <Border
                Grid.Column="0"
                Background="AliceBlue"
                CornerRadius="4">
                <Border.Effect>
                    <DropShadowEffect
                        BlurRadius="50"
                        Direction="280"
                        Opacity="0.2"
                        ShadowDepth="15"
                        Color="Black" />
                </Border.Effect>

                <DataGrid
                    CellStyle="{StaticResource CellStyle}"
                    ColumnHeaderStyle="{StaticResource ColumnHeaderStyle}"
                    ItemsSource="{Binding ProductEntries}"
                    Style="{StaticResource DataGridStyle}">

                    <DataGrid.Columns>

                        <DataGridTemplateColumn Width="100" Header="Rasm">
                            <DataGridTemplateColumn.CellTemplate>
                                <DataTemplate>
                                    <Image
                                        Width="80"
                                        Height="80"
                                        Source="{Binding Product.Image, Converter={StaticResource ImageFallbackConverter}}" />
                                </DataTemplate>
                            </DataGridTemplateColumn.CellTemplate>
                        </DataGridTemplateColumn>

                        <DataGridComboBoxColumn
                            Width="0.5*"
                            EditingElementStyle="{StaticResource ProductCodeComboBoxStyle}"
                            ElementStyle="{StaticResource ProductCodeComboBoxStyle}"
                            Header="Kod"
                            SelectedItemBinding="{Binding Product, Mode=TwoWay, UpdateSourceTrigger=PropertyChanged}" />

                        <DataGridComboBoxColumn
                            Width="*"
                            EditingElementStyle="{StaticResource ProductNameComboBoxStyle}"
                            ElementStyle="{StaticResource ProductNameComboBoxStyle}"
                            Header="Nomi"
                            SelectedItemBinding="{Binding Product, Mode=TwoWay, UpdateSourceTrigger=PropertyChanged}" />

                        <DataGridTemplateColumn Width="0.7*" Header="O'lcham">
                            <DataGridTemplateColumn.CellTemplate>
                                <DataTemplate>
                                    <ComboBox
                                        DisplayMemberPath="Type"
                                        ItemsSource="{Binding Product.ProductTypes}"
                                        SelectedItem="{Binding ProductType, Mode=TwoWay, UpdateSourceTrigger=PropertyChanged}"
                                        Style="{StaticResource ProductNameComboBoxStyle}" />
                                </DataTemplate>
                            </DataGridTemplateColumn.CellTemplate>
                        </DataGridTemplateColumn>

                        <!--  To'plamdagi mahsulotlar soni  -->
                        <DataGridTemplateColumn Width="0.7*" Header="To'plamdagi mahsulotlar soni">
                            <DataGridTemplateColumn.CellTemplate>
                                <DataTemplate>
                                    <TextBox
                                        Padding="8,0"
                                        VerticalContentAlignment="Center"
                                        Background="Transparent"
                                        BorderThickness="0"
                                        Foreground="Black"
                                        Text="{Binding BundleItemCount, Mode=TwoWay, UpdateSourceTrigger=PropertyChanged, StringFormat=N0}"
                                        TextAlignment="Right" />
                                </DataTemplate>
                            </DataGridTemplateColumn.CellTemplate>
                        </DataGridTemplateColumn>

                        <!--  Jami soni  -->
                        <DataGridTemplateColumn Width="0.7*" Header="Jami soni">
                            <DataGridTemplateColumn.CellTemplate>
                                <DataTemplate>
                                    <TextBox
                                        Padding="8,0"
                                        VerticalContentAlignment="Center"
                                        Background="Transparent"
                                        BorderThickness="0"
                                        Foreground="Black"
                                        Text="{Binding Count, Mode=TwoWay, UpdateSourceTrigger=PropertyChanged, StringFormat=N0}"
                                        TextAlignment="Right" />
                                </DataTemplate>
                            </DataGridTemplateColumn.CellTemplate>
                        </DataGridTemplateColumn>

                        <!--  Jarayondagi maxsulotlar  -->
                        <!--<DataGridTemplateColumn Width="0.7*" Header="Jarayondagi jami maxsulotlar">
                            <DataGridTemplateColumn.CellTemplate>
                                <DataTemplate>
                                    <TextBlock Style="{StaticResource TextStyle}"
                       Text="{Binding AvailableCount, StringFormat=N0}" />
                                </DataTemplate>
                            </DataGridTemplateColumn.CellTemplate>
                        </DataGridTemplateColumn>-->

                        <!--  Actions  -->
                        <DataGridTemplateColumn Width="60" Header="">
                            <DataGridTemplateColumn.CellTemplate>
                                <DataTemplate>
                                    <Button
                                        Padding="6"
                                        Background="Transparent"
                                        BorderThickness="0"
                                        Click="DeleteButton_Click"
                                        Content="🗑"
                                        FontSize="16"
                                        Foreground="Black"
                                        Tag="{Binding}"
                                        ToolTip="O'chirish" />
                                </DataTemplate>
                            </DataGridTemplateColumn.CellTemplate>
                        </DataGridTemplateColumn>
                    </DataGrid.Columns>
                </DataGrid>
            </Border>

            <!--  Right Panel - Semi Products  -->
            <Border
                Grid.Column="2"
                Padding="10"
                Background="#f1f1f1"
                CornerRadius="4">
                <Border.Effect>
                    <DropShadowEffect
                        BlurRadius="50"
                        Direction="300"
                        Opacity="0.3"
                        ShadowDepth="15"
                        Color="Black" />
                </Border.Effect>

                <Grid>
                    <ScrollViewer VerticalScrollBarVisibility="Auto" Visibility="{Binding SelectedProduct, Converter={StaticResource NullToVisibility}}">
                        <StackPanel Orientation="Vertical">
                            <!--  Title  -->
                            <TextBlock
                                Margin="0,0,0,10"
                                FontSize="14"
                                FontWeight="SemiBold"
                                Foreground="{StaticResource PrimaryTextColor}"
                                Text="Yarim tayyor mahsulotlar" />

                            <!--  Semi Products List  -->
                            <ItemsControl ItemsSource="{Binding SelectedProduct.AvailableSemiProducts}">
                                <ItemsControl.ItemTemplate>
                                    <DataTemplate>
                                        <Border
                                            Margin="0,0,0,8"
                                            Padding="10"
                                            Background="White"
                                            BorderBrush="#E0E0E0"
                                            BorderThickness="1"
                                            CornerRadius="4">
                                            <Grid>
                                                <Grid.RowDefinitions>
                                                    <RowDefinition Height="Auto" />
                                                    <RowDefinition Height="8" />
                                                    <RowDefinition Height="Auto" />
                                                </Grid.RowDefinitions>

                                                <!--  Semi Product Header  -->
                                                <Grid Grid.Row="0">
                                                    <Grid.ColumnDefinitions>
                                                        <ColumnDefinition Width="50" />
                                                        <ColumnDefinition Width="*" />
                                                    </Grid.ColumnDefinitions>

                                                    <!--  Image  -->
                                                    <Border
                                                        Grid.Column="0"
                                                        Width="45"
                                                        Height="45"
                                                        Background="#F5F5F5"
                                                        CornerRadius="4">
                                                        <Image Source="{Binding SemiProduct.Image, Converter={StaticResource ImageFallbackConverter}}" Stretch="Uniform" />
                                                    </Border>

                                                    <!--  Name  -->
                                                    <TextBlock
                                                        Grid.Column="1"
                                                        Margin="8,0,0,0"
                                                        VerticalAlignment="Center"
                                                        FontSize="13"
                                                        FontWeight="SemiBold"
                                                        Foreground="#424242"
                                                        Text="{Binding SemiProduct.Name}"
                                                        TextWrapping="Wrap" />
                                                </Grid>

                                                <!--  Details  -->
                                                <Grid Grid.Row="2">
                                                    <Grid.ColumnDefinitions>
                                                        <ColumnDefinition Width="*" />
                                                        <ColumnDefinition Width="*" />
                                                    </Grid.ColumnDefinitions>

                                                    <!--  Quantity  -->
                                                    <StackPanel Grid.Column="0">
                                                        <TextBlock
                                                            FontSize="10"
                                                            Foreground="#757575"
                                                            Text="Miqdori:" />
                                                        <TextBlock
                                                            FontSize="12"
                                                            FontWeight="SemiBold"
                                                            Foreground="#424242">
                                                            <Run Text="{Binding Quantity, StringFormat=N2}" />
                                                            <Run Text="{Binding SemiProduct.UnitMeasure.Name}" />
                                                        </TextBlock>
                                                    </StackPanel>

                                                    <!--  Cost  -->
                                                    <StackPanel Grid.Column="1">
                                                        <TextBlock
                                                            FontSize="10"
                                                            Foreground="#757575"
                                                            Text="Narxi:" />
                                                        <TextBlock
                                                            FontSize="12"
                                                            FontWeight="SemiBold"
                                                            Foreground="#43A047"
                                                            Text="{Binding SemiProduct.CostPrice, StringFormat=N0}" />
                                                    </StackPanel>
                                                </Grid>
                                            </Grid>
                                        </Border>
                                    </DataTemplate>
                                </ItemsControl.ItemTemplate>
                            </ItemsControl>
                        </StackPanel>
                    </ScrollViewer>

                    <!--  Empty State  -->
                    <StackPanel
                        HorizontalAlignment="Center"
                        VerticalAlignment="Center"
                        Visibility="{Binding SelectedProduct, Converter={StaticResource NullToVisibility}}">
                        <TextBlock
                            FontSize="14"
                            Foreground="#9E9E9E"
                            Text="Mahsulot tanlanmagan"
                            TextAlignment="Center" />
                    </StackPanel>
                </Grid>
            </Border>
        </Grid>

        <!--  Submit Button  -->
        <Button
            Grid.Row="2"
            Margin="0,5,0,0"
            HorizontalAlignment="Right"
            md:ButtonAssist.CornerRadius="4"
            md:ElevationAssist.Elevation="Dp24"
            Background="{StaticResource SuccessButtonBackground}"
            BorderBrush="{StaticResource SuccessButtonBorder}"
            Command="{Binding SubmitCommand}"
            Content="Yuborish"
            Foreground="{StaticResource SuccessButtonForeground}" />
    </Grid>
</Page>