<Page
    x:Class="Forex.Wpf.Pages.ShopCashes.ShopCashPage"
    xmlns="http://schemas.microsoft.com/winfx/2006/xaml/presentation"
    xmlns:x="http://schemas.microsoft.com/winfx/2006/xaml"
    xmlns:controls="clr-namespace:Forex.Wpf.Resources.UserControls"
    xmlns:d="http://schemas.microsoft.com/expression/blend/2008"
    xmlns:local="clr-namespace:Forex.Wpf.Pages.ShopCashes"
    xmlns:mc="http://schemas.openxmlformats.org/markup-compatibility/2006"
    xmlns:md="http://materialdesigninxaml.net/winfx/xaml/themes"
    Title="Kassa boshqaruvi"
    d:DesignHeight="700"
    d:DesignWidth="1000"
    mc:Ignorable="d">

    <Grid Margin="16" Background="AliceBlue">
        <Grid.RowDefinitions>
            <RowDefinition Height="Auto" />
            <RowDefinition Height="Auto" />
            <RowDefinition Height="Auto" />
            <RowDefinition Height="Auto" />
            <RowDefinition Height="*" />
        </Grid.RowDefinitions>

        <!--  Header  -->
        <Grid Grid.Row="0" Margin="5">
            <Label
                Content="🏦 Kassa amaliyotlari"
                FontSize="20"
                FontWeight="Bold"
                Foreground="{StaticResource SecondaryTextColor}" />
            <Button
                Padding="8,4"
                HorizontalAlignment="Right"
                VerticalAlignment="Top"
                md:ElevationAssist.Elevation="Dp8"
                Background="{DynamicResource OtherBackground}"
                Click="BtnBack_Click"
                Content="🔙 Orqaga" />
        </Grid>

        <!--  Shop Accounts Cards  -->
        <ItemsControl Grid.Row="1" ItemsSource="{Binding AvailableShopAccounts}">
            <ItemsControl.ItemsPanel>
                <ItemsPanelTemplate>
                    <WrapPanel
                        HorizontalAlignment="Stretch"
                        ItemHeight="100"
                        ItemWidth="320"
                        Orientation="Horizontal" />
                </ItemsPanelTemplate>
            </ItemsControl.ItemsPanel>

            <ItemsControl.ItemTemplate>
                <DataTemplate>
                    <md:Card
                        Width="280"
                        Margin="10"
                        VerticalContentAlignment="Center"
                        md:ShadowAssist.Darken="True"
                        Background="{DynamicResource MaterialDesignPaper}"
                        BorderThickness="3"
                        Foreground="{DynamicResource PrimaryTextColor}"
                        UniformCornerRadius="6">
                        <StackPanel>
                            <TextBlock
                                HorizontalAlignment="Center"
                                FontSize="18"
                                FontWeight="SemiBold"
                                Foreground="{DynamicResource PrimaryTextColor}"
                                Text="{Binding Currency.Name}" />

                            <StackPanel HorizontalAlignment="Center" Orientation="Horizontal">
                                <TextBlock
                                    FontSize="16"
                                    FontWeight="Medium"
                                    Foreground="{DynamicResource PrimaryTextColor}"
                                    Text="Qoldiq:" />
                                <TextBlock
                                    Margin="10,0,0,0"
                                    FontSize="16"
                                    FontWeight="Bold"
                                    Foreground="{DynamicResource PrimaryHueMidBrush}"
                                    Text="{Binding Balance, StringFormat=N2}" />
                                <TextBlock
                                    Margin="8,0,0,0"
                                    FontSize="16"
                                    FontWeight="Bold"
                                    Foreground="{DynamicResource PrimaryHueMidBrush}"
                                    Text="{Binding Currency.Code}" />
                            </StackPanel>
                        </StackPanel>
                    </md:Card>
                </DataTemplate>
            </ItemsControl.ItemTemplate>
        </ItemsControl>

        <!--  Transaction Form  -->
        <Grid Grid.Row="2" Margin="0,5">
            <Grid.ColumnDefinitions>
                <ColumnDefinition Width="*" MaxWidth="500" />
                <ColumnDefinition Width="20" />
                <ColumnDefinition Width="*" />
            </Grid.ColumnDefinitions>

            <!--  Left Section: Transaction Details  -->
            <Grid>
                <Grid.ColumnDefinitions>
                    <ColumnDefinition Width="80" />
                    <ColumnDefinition Width="*" />
                    <ColumnDefinition Width="90" />
                    <ColumnDefinition Width="*" />
                </Grid.ColumnDefinitions>
                <Grid.RowDefinitions>
                    <RowDefinition Height="*" />
                    <RowDefinition Height="*" />
                    <RowDefinition Height="*" />
                    <RowDefinition Height="*" />
                    <RowDefinition Height="*" />
                </Grid.RowDefinitions>

                <!--  Row 0: Date and User  -->
                <Label Content="Sana:" FontSize="14" VerticalAlignment="Center" Margin="5,0,0,0" />
                <controls:UserCalendar
                    Grid.Column="1"
                    Height="26"
                    Margin="0,1,0,1"
                    FontSize="14"
                    SelectedDate="{Binding Transaction.Date, Mode=TwoWay, UpdateSourceTrigger=PropertyChanged}" />

                <Label Grid.Column="2" Content="User:" FontSize="14" HorizontalAlignment="Right" VerticalAlignment="Center" Margin="5,0,0,0" />
                <Border Grid.Column="3" Margin="0,2" BorderBrush="{DynamicResource PrimaryTextColor}" BorderThickness="1" CornerRadius="4">
                    <ComboBox
                        Padding="5,1"
                        BorderThickness="0"
                        DisplayMemberPath="Name"
                        FontSize="14"
                        IsTextSearchEnabled="True"
                        ItemsSource="{Binding AvailableUsers}"
                        SelectedItem="{Binding Transaction.User}" />
                </Border>

                <!--  Row 1: Currency and Income  -->
                <Label Grid.Row="1" Content="Val. turi:" FontSize="14" VerticalAlignment="Center" Margin="5,0,0,0" />
                <Border Grid.Row="1" Grid.Column="1" Margin="0,2,10,2" BorderBrush="{DynamicResource PrimaryTextColor}" BorderThickness="1" CornerRadius="4">
                    <ComboBox
                        Padding="5,1"
                        BorderThickness="0"
                        DisplayMemberPath="Name"
                        FontSize="14"
                        ItemsSource="{Binding AvailableCurrencies}"
                        SelectedItem="{Binding Transaction.Currency}" />
                </Border>

                <Label Grid.Row="1" Grid.Column="2" Content="Kirim:" FontSize="14" HorizontalAlignment="Right" VerticalAlignment="Center" />
                <Border Grid.Row="1" Grid.Column="3" Margin="0,2" BorderBrush="{DynamicResource PrimaryTextColor}" BorderThickness="1" CornerRadius="4"
                        IsEnabled="{Binding Transaction.IsExpense, Converter={StaticResource InverseBoolToBoolConverter}}">
                    <TextBox
                        x:Name="tbKirim"
                        Padding="3,0"
                        BorderThickness="0"
                        FontSize="14"
                        PreviewTextInput="NumericTextBox_PreviewTextInput"
                        Text="{Binding Transaction.Income, StringFormat={}{0:N0}, UpdateSourceTrigger=PropertyChanged, TargetNullValue=''}"
                        TextAlignment="Right" />
                </Border>

                <!--  Row 2: Payment Method and Expense  -->
                <Label Grid.Row="2" Content="To'lov turi:" FontSize="14" VerticalAlignment="Center" Margin="5,0,0,0" />
                <Border Grid.Row="2" Grid.Column="1" Margin="0,2,10,2" BorderBrush="{DynamicResource PrimaryTextColor}" BorderThickness="1" CornerRadius="4">
                    <ComboBox
                        Padding="5,1"
                        BorderThickness="0"
                        FontSize="14"
                        ItemsSource="{Binding AvailablePaymentMethods}"
                        SelectedItem="{Binding Transaction.PaymentMethod}">
                        <ComboBox.ItemTemplate>
                            <DataTemplate>
                                <TextBlock Text="{Binding Converter={StaticResource EnumDescriptionConverter}}" />
                            </DataTemplate>
                        </ComboBox.ItemTemplate>
                    </ComboBox>
                </Border>

                <Label Grid.Row="2" Grid.Column="2" Content="Chiqim:" FontSize="14" HorizontalAlignment="Right" VerticalAlignment="Center" />
                <Border Grid.Row="2" Grid.Column="3" Margin="0,2" BorderBrush="{DynamicResource PrimaryTextColor}" BorderThickness="1" CornerRadius="4"
                        IsEnabled="{Binding Transaction.IsIncome, Converter={StaticResource InverseBoolToBoolConverter}}">
                    <TextBox
                        x:Name="tbChiqim"
                        Padding="3,0"
                        BorderThickness="0"
                        FontSize="14"
                        PreviewTextInput="NumericTextBox_PreviewTextInput"
                        Text="{Binding Transaction.Expense, StringFormat={}{0:N0}, UpdateSourceTrigger=PropertyChanged, TargetNullValue=''}"
                        TextAlignment="Right" />
                </Border>

                <!--  Row 3: Exchange Rate and Discount  -->
                <Label Grid.Row="3" Content="Kurs:" FontSize="14" VerticalAlignment="Center" Margin="5,0,0,0" />
                <Border Grid.Row="3" Grid.Column="1" Margin="0,2,10,2" BorderBrush="{DynamicResource PrimaryTextColor}" BorderThickness="1" CornerRadius="4">
                    <TextBox
                        Padding="3,0"
                        BorderThickness="0"
                        FontSize="14"
                        IsEnabled="{Binding Transaction.Currency.IsEditable}"
                        PreviewTextInput="NumericTextBox_PreviewTextInput"
                        Text="{Binding Transaction.ExchangeRate, StringFormat={}{0:N0}, TargetNullValue=''}"
                        TextAlignment="Right" />
                </Border>

                <Label Grid.Row="3" Grid.Column="2" Content="Chegirma:" FontSize="14" HorizontalAlignment="Right" VerticalAlignment="Center" />
                <Border Grid.Row="3" Grid.Column="3" Margin="0,2" BorderBrush="{DynamicResource PrimaryTextColor}" BorderThickness="1" CornerRadius="4">
                    <TextBox
                        Padding="3,0"
                        BorderThickness="0"
                        FontSize="14"
                        IsEnabled="{Binding Transaction.IsIncome}"
                        PreviewTextInput="NumericTextBox_PreviewTextInput"
                        Text="{Binding Transaction.Discount, StringFormat={}{0:N0}, UpdateSourceTrigger=PropertyChanged, TargetNullValue=''}"
                        TextAlignment="Right" />
                </Border>

                <!--  Row 4: Description  -->
                <Label Grid.Row="4" Content="Izoh:" FontSize="14" VerticalAlignment="Center" Margin="5,0,0,0" />
                <Border Grid.Row="4" Grid.Column="1" Grid.ColumnSpan="3" Margin="0,2" BorderBrush="{DynamicResource PrimaryTextColor}" BorderThickness="1" CornerRadius="4">
                    <TextBox
                        Padding="3,0"
                        BorderThickness="0"
                        FontSize="14"
                        Text="{Binding Transaction.Description}" />
                </Border>
            </Grid>

            <!--  Right Section: Account Summary  -->
            <Grid Grid.Column="2">
                <Grid.ColumnDefinitions>
                    <ColumnDefinition Width="80" />
                    <ColumnDefinition Width="150" />
                    <ColumnDefinition Width="100" />
                    <ColumnDefinition Width="*" />
                </Grid.ColumnDefinitions>
                <Grid.RowDefinitions>
                    <RowDefinition Height="*" />
                    <RowDefinition Height="*" />
                    <RowDefinition Height="*" />
                    <RowDefinition Height="*" />
                    <RowDefinition Height="*" />
                    <RowDefinition Height="*" />
                </Grid.RowDefinitions>

                <TextBlock Grid.ColumnSpan="2" Text="Hisob:" FontSize="14" FontWeight="Bold" FontStyle="Italic" HorizontalAlignment="Center" VerticalAlignment="Center" />

                <TextBlock Grid.Row="1" Text="Joriy:" FontSize="14" HorizontalAlignment="Right" VerticalAlignment="Center" />
                <TextBox Grid.Row="1" Grid.Column="1" Background="Transparent" BorderThickness="0" FontSize="14" IsReadOnly="True" IsTabStop="False"
                         Text="{Binding Transaction.TotalAmountWithUserBalance, StringFormat={}{0:N2}, TargetNullValue=''}" HorizontalAlignment="Right" />

                <TextBlock Grid.Row="2" Text="Qoldiq:" FontSize="14" HorizontalAlignment="Right" VerticalAlignment="Center" />
                <TextBox Grid.Row="2" Grid.Column="1" Background="Transparent" BorderThickness="0" FontSize="14" IsReadOnly="True"
                         Text="{Binding Transaction.User.Balance, StringFormat={}{0:N2}, TargetNullValue=''}" HorizontalAlignment="Right" />

                <TextBlock Grid.Row="3" Text="Telefon:" FontSize="14" HorizontalAlignment="Right" VerticalAlignment="Center" />
                <TextBox Grid.Row="3" Grid.Column="1" Background="Transparent" BorderThickness="0" FontSize="14" IsReadOnly="True" IsTabStop="False"
                         Text="{Binding Transaction.User.Phone}" HorizontalAlignment="Right" />

                <TextBlock Grid.Row="4" Grid.RowSpan="2" Text="To'lash sana:" FontSize="14" HorizontalAlignment="Left" VerticalAlignment="Center"
                           Visibility="{Binding Transaction.IsDebtor, Converter={StaticResource BoolToVisibilityConverter}}" />
                <controls:UserCalendar
                    Grid.Row="4" Grid.RowSpan="2" Grid.Column="1"
                    Height="25"
                    Margin="10,0"
                    FontSize="14"
                    Visibility="{Binding Transaction.IsDebtor, Converter={StaticResource BoolToVisibilityConverter}}"
                    SelectedDate="{Binding Transaction.DueDate, Mode=TwoWay}" />

                <Button
                    Grid.Row="4" Grid.RowSpan="2" Grid.Column="2"
                    Height="28"
                    Margin="10,0"
                    md:ElevationAssist.Elevation="Dp8"
                    Background="{StaticResource SuccessButtonBackground}"
                    BorderBrush="{StaticResource SuccessButtonBorder}"
                    Command="{Binding SubmitCommand}"
                    Content="To'lash"
                    Foreground="{StaticResource SuccessButtonForeground}" />
            </Grid>
        </Grid>

        <!--  History Filter  -->
        <md:Card Grid.Row="3" Margin="5,1,5,10" Background="#F1F1F1" UniformCornerRadius="4">
            <StackPanel Margin="5" Orientation="Horizontal">
                <TextBlock Text="Kassa amaliyotlar tarixi" FontSize="20" FontWeight="Medium" VerticalAlignment="Center" Margin="5,0,20,0" />

                <TextBlock Text="Boshlanish sana:" FontSize="14" VerticalAlignment="Center" />
                <Border Margin="2,5" Background="{DynamicResource SecondaryBackground}" CornerRadius="4">
                    <controls:UserCalendar
                        Height="28"
                        MinWidth="100"
                        Margin="5,0"
                        FontSize="14"
                        SelectedDate="{Binding BeginDate}" />
                </Border>

                <TextBlock Text="Tugash sana:" FontSize="14" VerticalAlignment="Center" />
                <Border Margin="2,5" Background="{DynamicResource SecondaryBackground}" CornerRadius="4">
                    <controls:UserCalendar
                        Width="100"
                        Height="28"
                        Margin="5,0"
                        FontSize="14"
                        SelectedDate="{Binding EndDate}" />
                </Border>

                <Button
                    Height="28"
                    Margin="3"
                    md:ElevationAssist.Elevation="Dp8"
                    Background="{DynamicResource OtherBackground}"
                    Command="{Binding FilterHistoryCommand}"
                    Content="Ko'rsatish" />
            </StackPanel>
        </md:Card>

        <!--  Transaction History DataGrid  -->
        <DataGrid
            Grid.Row="4"
            Margin="5"
            AlternatingRowBackground="#F9F9F9"
            AutoGenerateColumns="False"
            CanUserAddRows="False"
            HeadersVisibility="Column"
            IsReadOnly="True"
            ItemsSource="{Binding Transactions}"
            SelectionMode="Single">

            <DataGrid.Resources>
                <Style x:Key="RightAlignedCellStyle" TargetType="TextBlock">
                    <Setter Property="TextAlignment" Value="Right" />
                    <Setter Property="Padding" Value="0,0,5,0" />
                </Style>

                <Style x:Key="CenterAlignedCellStyle" TargetType="TextBlock">
                    <Setter Property="TextAlignment" Value="Center" />
                </Style>

                <Style TargetType="DataGridColumnHeader">
                    <Setter Property="HorizontalContentAlignment" Value="Center" />
                </Style>
            </DataGrid.Resources>

            <DataGrid.Columns>
                <DataGridTextColumn Width="120" Binding="{Binding Date, StringFormat={}{0:dd.MM.yyyy}}" ElementStyle="{StaticResource CenterAlignedCellStyle}" Header="Sana" />
                <DataGridTextColumn Width="2*" Binding="{Binding User.Name}" Header="User" />
                <DataGridTextColumn Width="*" Binding="{Binding PaymentMethod}" ElementStyle="{StaticResource CenterAlignedCellStyle}" Header="To'lov turi" />
                <DataGridTextColumn Width="0.5*" Binding="{Binding Currency.Name}" ElementStyle="{StaticResource CenterAlignedCellStyle}" Header="Valyuta turi" />
                <DataGridTextColumn Width="0.5*" Binding="{Binding ExchangeRate, StringFormat={}{0:N2}}" ElementStyle="{StaticResource RightAlignedCellStyle}" Header="Kurs" />
                <DataGridTextColumn Width="*" Binding="{Binding Income, StringFormat={}{0:N2}}" ElementStyle="{StaticResource RightAlignedCellStyle}" Header="Kirim" />
                <DataGridTextColumn Width="*" Binding="{Binding Expense, StringFormat={}{0:N2}}" ElementStyle="{StaticResource RightAlignedCellStyle}" Header="Chiqim" />
                <DataGridTextColumn Width="2*" Binding="{Binding Description}" Header="Izoh" />
            </DataGrid.Columns>
        </DataGrid>
    </Grid>
</Page>